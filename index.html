<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangunan Kediri - Pembuat RAB Otomatis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --whatsapp-color: #25D366;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .navbar {
            background-color: var(--primary-color);
        }
        
        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }
        
        .hero-section {
            background: linear-gradient(rgba(44, 62, 80, 0.8), rgba(44, 62, 80, 0.8)), url('https://images.unsplash.com/photo-1541888946425-d81bb19240f5?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center;
            background-size: cover;
            color: white;
            padding: 80px 0;
            text-align: center;
        }
        
        .card {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border: none;
        }
        
        .btn-success {
            background-color: #27ae60;
            border: none;
        }
        
        .btn-warning {
            background-color: #f39c12;
            border: none;
            color: white;
        }
        
        .btn-whatsapp {
            background-color: var(--whatsapp-color);
            border: none;
            color: white;
        }
        
        .btn-whatsapp:hover {
            background-color: #128C7E;
        }
        
        .btn-pdf {
            background-color: #e74c3c;
            border: none;
            color: white;
        }
        
        .btn-pdf:hover {
            background-color: #c0392b;
        }
        
        .table th {
            background-color: var(--light-color);
        }
        
        .total-section {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        /* Invoice Section - Format A4 */
        .invoice-section {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 30px;
            width: 794px; /* Lebar A4 dalam pixel (210mm) */
            min-height: 1123px; /* Tinggi A4 dalam pixel (297mm) */
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }
        
        .invoice-header {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px; /* Dikurangi dari 20px */
            margin-bottom: 15px; /* Dikurangi dari 20px */
        }
        
        .invoice-logo {
            max-width: 120px;
            height: auto;
        }
        
        .company-details {
            padding-left: 20px;
        }
        
        .company-details h4 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 3px; /* Dikurangi dari 5px */
            color: #2c3e50;
        }
        
        .company-details p {
            margin-bottom: 1px; /* Dikurangi dari 2px */
            font-size: 0.9rem;
            line-height: 1.2; /* Dikurangi dari 1.3 */
        }
        
        .document-type-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 8px; /* Dikurangi dari 10px */
        }
        
        .badge-invoice {
            background-color: #3498db;
            color: white;
        }
        
        .badge-quotation {
            background-color: #2ecc71;
            color: white;
        }
        
        .signature-area {
            margin-top: 40px; /* Dikurangi dari 60px */
            padding-top: 15px; /* Dikurangi dari 20px */
            border-top: 1px dashed #ccc;
            position: relative;
        }
        
        .signature-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px; /* Dikurangi dari 40px */
            position: relative;
        }
        
        .client-signature, .director-signature {
            width: 45%;
            text-align: center;
            position: relative;
        }
        
        .director-signature {
            position: relative;
        }
        
        .signature-line {
            width: 100%;
            height: 1px;
            background-color: #000;
            margin: 50px 0 5px 0; /* Dikurangi dari 60px */
        }
        
        /* Posisi stempel di atas TTD direktur, agak ke kiri */
        .stempel-over-signature {
            position: absolute;
            width: 130px; /* Diperbesar dari 100px */
            height: 130px; /* Diperbesar dari 100px */
            opacity: 0.9;
            z-index: 10;
            top: -20px;
            left: 20px;
            transform: rotate(-5deg);
        }
        
        /* Print Styles untuk A4 */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .invoice-section, .invoice-section * {
                visibility: visible;
            }
            
            .invoice-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 15mm;
                box-shadow: none;
                page-break-after: always;
            }
            
            .no-print {
                display: none !important;
            }
            
            /* Pastikan tabel tidak terpotong saat dicetak */
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            /* Menambahkan margin untuk printer */
            @page {
                size: A4;
                margin: 15mm;
            }
        }
        
        footer {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            margin-top: 40px;
        }
        
        .feature-icon {
            font-size: 2.5rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }
        
        .section-title {
            position: relative;
            margin-bottom: 40px;
            text-align: center;
        }
        
        .section-title:after {
            content: '';
            display: block;
            width: 80px;
            height: 3px;
            background-color: var(--secondary-color);
            margin: 15px auto;
        }
        
        .watermark {
            position: absolute;
            opacity: 0.1;
            font-size: 120px;
            font-weight: bold;
            color: #ccc;
            transform: rotate(-45deg);
            top: 40%;
            left: 20%;
            z-index: 1;
            display: none;
        }
        
        /* Responsive untuk invoice */
        @media (max-width: 850px) {
            .invoice-section {
                width: 100%;
                min-height: auto;
                padding: 20px;
            }
            
            .signature-container {
                flex-direction: column;
            }
            
            .client-signature, .director-signature {
                width: 100%;
                margin-bottom: 30px;
            }
        }
        
        /* Loading spinner */
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .preview-image {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .document-type-selector {
            margin-bottom: 20px;
        }
        
        .document-type-selector .btn {
            margin-right: 10px;
        }
        
        .service-type-select {
            margin-bottom: 15px;
        }
        
        /* Styling untuk grouping item berdasarkan jasa */
        .service-group-header {
            background-color: #f8f9fa !important;
            font-weight: bold;
            border-left: 3px solid var(--secondary-color) !important;
        }
        
        .service-group-header td {
            padding-top: 12px !important; /* Dikurangi dari 15px */
            padding-bottom: 3px !important; /* Dikurangi dari 5px */
        }
        
        .item-row td {
            padding-left: 30px !important;
        }
        
        /* Mengurangi jarak antar baris di tabel */
        .table td, .table th {
            padding: 6px 8px !important; /* Dikurangi dari 8px 12px */
        }
        
        /* Mengurangi margin di bagian detail proyek dan klien */
        .row.mb-4 {
            margin-bottom: 1rem !important; /* Dikurangi dari 1.5rem */
        }
        
        /* Mengurangi margin di bagian catatan dan total */
        .row.mt-4 {
            margin-top: 1rem !important; /* Dikurangi dari 1.5rem */
        }
        
        /* Mengurangi padding di total section */
        .total-section {
            padding: 12px; /* Dikurangi dari 15px */
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-hard-hat me-2"></i>BANGUNAN KEDIRI</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#home"><i class="fas fa-home me-1"></i>Beranda</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#rabForm"><i class="fas fa-calculator me-1"></i>Buat RAB</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section" id="home">
        <div class="container">
            <h1 class="display-4">Pembuat RAB Otomatis</h1>
            <p class="lead">Hitung Rencana Anggaran Biaya (RAB) proyek konstruksi Anda dengan mudah dan cepat</p>
            <a href="#rabForm" class="btn btn-primary btn-lg mt-3"><i class="fas fa-calculator me-2"></i>Buat RAB Sekarang</a>
        </div>
    </div>

    <!-- Features Section -->
    <div class="container my-5">
        <div class="row text-center">
            <div class="col-md-4 mb-4">
                <div class="feature-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <h4>Cepat dan Mudah</h4>
                <p>Buat RAB dalam hitungan menit dengan sistem yang intuitif dan mudah digunakan.</p>
            </div>
            <div class="col-md-4 mb-4">
                <div class="feature-icon">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <h4>Invoice & Penawaran</h4>
                <p>Hasilkan invoice atau penawaran harga profesional format A4 yang siap dicetak.</p>
            </div>
            <div class="col-md-4 mb-4">
                <div class="feature-icon">
                    <i class="fab fa-whatsapp"></i>
                </div>
                <h4>Kirim ke WhatsApp</h4>
                <p>Kirim invoice langsung ke WhatsApp klien dalam format gambar JPG atau PDF.</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5" id="rabForm">
        <!-- Form Data Proyek -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-clipboard-list me-2"></i>Data Proyek
            </div>
            <div class="card-body">
                <form id="projectForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="projectNumber" class="form-label">Nomor Proyek <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="projectNumber" placeholder="BK001" required>
                            <small class="form-text text-muted">Contoh: BK001, BK002, dll.</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="projectName" class="form-label">Nama Proyek <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="projectName" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="clientName" class="form-label">Nama Klien <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="projectDate" class="form-label">Tanggal Proyek <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="projectDate" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="clientAddress" class="form-label">Alamat Klien <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="clientAddress" rows="3" required></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="clientPhone" class="form-label">Telepon/WhatsApp Klien <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">+62</span>
                                <input type="tel" class="form-control" id="clientPhone" placeholder="85746473070" required>
                            </div>
                            <small class="form-text text-muted">Contoh: 85746473070</small>
                        </div>
                    </div>
                    
                    <!-- Pilihan Jenis Dokumen -->
                    <div class="document-type-selector">
                        <label class="form-label">Jenis Dokumen <span class="text-danger">*</span></label>
                        <div>
                            <button type="button" class="btn btn-outline-primary active" id="invoiceTypeBtn">
                                <i class="fas fa-file-invoice me-1"></i>Invoice
                            </button>
                            <button type="button" class="btn btn-outline-success" id="quotationTypeBtn">
                                <i class="fas fa-file-contract me-1"></i>Penawaran Harga
                            </button>
                            <input type="hidden" id="documentType" value="invoice">
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Form Input Item -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-plus-circle me-2"></i>Input Item Pekerjaan
            </div>
            <div class="card-body">
                <form id="itemForm">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="serviceType" class="form-label">Jenis Jasa <span class="text-danger">*</span></label>
                            <select class="form-select" id="serviceType" required>
                                <option value="">Pilih Jenis Jasa</option>
                                <option value="Jasa Renovasi">Jasa Renovasi</option>
                                <option value="Jasa Bangun Rumah">Jasa Bangun Rumah</option>
                                <option value="Jasa Arsitek">Jasa Arsitek</option>
                                <option value="Jasa Buat Kolam">Jasa Buat Kolam</option>
                                <option value="Jasa Pasang Genting">Jasa Pasang Genting</option>
                                <option value="Jasa Pengecatan">Jasa Pengecatan</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="itemName" class="form-label">Nama Item <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="quantity" class="form-label">Volume <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="quantity" min="0" step="0.01" required>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="unit" class="form-label">Satuan <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="unit" placeholder="m², m³, unit, dll" required>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="unitPrice" class="form-label">Harga Satuan (Rp) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="unitPrice" min="0" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-1"></i>Tambah Item</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabel Daftar Item -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-tasks me-2"></i>Daftar Item Pekerjaan</span>
                <button id="clearAllBtn" class="btn btn-sm btn-danger"><i class="fas fa-trash me-1"></i>Hapus Semua</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="itemsTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Jenis Jasa</th>
                                <th>Nama Item</th>
                                <th>Volume</th>
                                <th>Satuan</th>
                                <th>Harga Satuan</th>
                                <th>Total</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="itemsList">
                            <!-- Items will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Total Section -->
                <div class="total-section">
                    <div class="row">
                        <div class="col-md-6 offset-md-6">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="subtotal">Rp 0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>PPN (10%):</span>
                                <span id="tax">Rp 0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Diskon:</span>
                                <span id="discount">Rp 0</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold fs-5">
                                <span>Total:</span>
                                <span id="total">Rp 0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end mt-3">
                    <button id="generateDocumentBtn" class="btn btn-success me-2"><i class="fas fa-file-invoice me-1"></i>Buat Dokumen</button>
                    <button id="printDocumentBtn" class="btn btn-primary me-2"><i class="fas fa-print me-1"></i>Cetak</button>
                    <button id="downloadPdfBtn" class="btn btn-pdf me-2"><i class="fas fa-file-pdf me-1"></i>Download PDF</button>
                    <button id="sendWhatsAppBtn" class="btn btn-whatsapp"><i class="fab fa-whatsapp me-1"></i>Kirim ke WhatsApp</button>
                </div>
            </div>
        </div>

        <!-- Document Section - Format A4 -->
        <div class="invoice-section" id="invoiceSection">
            <div class="watermark">BANGUNAN KEDIRI</div>
            
            <div class="invoice-header">
                <div class="row">
                    <div class="col-md-6 d-flex align-items-start">
                        <img src="img/logo.png" alt="Bangunan Kediri" class="invoice-logo">
                        <div class="company-details">
                            <h4 class="mt-0 mb-2">Bangunan Kediri</h4>
                            <p class="mb-1">Jl. Sumur pompa, RT.06 RW.02</p>
                            <p class="mb-1">Ds. Gabru Kec. Gurah Kediri</p>
                            <p class="mb-1">Telp/WA : 085746473070</p>
                            <p class="mb-0">bangunankediri2025@gmail.com</p>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div id="documentTypeBadge" class="document-type-badge badge-invoice">INVOICE</div>
                        <h2 id="documentTitle" class="text-uppercase mb-2">INVOICE</h2>
                        <p class="mb-1"><strong>No. Dokumen:</strong> <span id="documentNumber">BK/001/INV/I/2025</span></p>
                        <p class="mb-1"><strong>Tanggal:</strong> <span id="documentDate">01/01/2025</span></p>
                        <p class="mb-0" id="dueDateContainer"><strong>Jatuh Tempo:</strong> <span id="dueDate">15/01/2025</span></p>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <h5 class="mb-2">Kepada:</h5>
                    <p id="documentClientName" class="fw-bold mb-1">Nama Klien</p>
                    <p id="documentClientAddress" class="mb-1">Alamat Klien</p>
                    <p id="documentClientPhone" class="mb-0">Telp/WA: -</p>
                </div>
                <div class="col-md-6">
                    <h5 class="mb-2">Detail Proyek:</h5>
                    <p id="documentProjectName" class="fw-bold mb-1">Nama Proyek</p>
                    <p id="documentProjectNumber" class="mb-1">No. Proyek: -</p>
                    <p id="documentProjectDate" class="mb-0">Tanggal: -</p>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-bordered" id="documentTable">
                    <thead>
                        <tr>
                            <th width="5%">No</th>
                            <th width="55%">Jenis Jasa / Nama Item</th>
                            <th width="10%">Volume</th>
                            <th width="10%">Satuan</th>
                            <th width="20%">Total (Rp)</th>
                        </tr>
                    </thead>
                    <tbody id="documentItemsList">
                        <!-- Document items will be added here -->
                    </tbody>
                </table>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="mb-2">
                        <label for="documentNotes" class="form-label">Catatan:</label>
                        <textarea class="form-control" id="documentNotes" rows="3">Pembayaran dapat dilakukan via transfer ke:
Bank: BCA Kediri
No. Rekening: 123-456-7890
Atas Nama: BANGUNAN KEDIRI

Pembayaran dianggap lunas setelah dana diterima.</textarea>
                    </div>
                    <div class="mb-2">
                        <label for="documentTerms" class="form-label">Syarat Pembayaran:</label>
                        <textarea class="form-control" id="documentTerms" rows="2">50% diawal, 50% setelah pekerjaan selesai</textarea>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="total-section">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Subtotal:</span>
                            <span id="documentSubtotal">Rp 0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span>PPN (10%):</span>
                            <span id="documentTax">Rp 0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Diskon:</span>
                            <span id="documentDiscount">Rp 0</span>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>TOTAL PEMBAYARAN:</span>
                            <span id="documentTotal">Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Area Tanda Tangan Berdampingan dengan Stempel di TTD Direktur -->
            <div class="signature-area">
                <div class="signature-container">
                    <!-- Tanda Tangan Klien -->
                    <div class="client-signature">
                        <p class="mb-1">Diterima oleh,</p>
                        <div class="signature-line"></div>
                        <p id="documentClientSignatureName" class="fw-bold mt-1">(Nama Klien)</p>
                        <p>Klien</p>
                    </div>
                    
                    <!-- Tanda Tangan Direktur dengan Stempel di atasnya -->
                    <div class="director-signature">
                        <!-- Stempel ditempatkan di atas tanda tangan direktur, agak ke kiri -->
                        <img src="img/stempel.png" alt="Stempel Perusahaan" class="stempel-over-signature">
                        
                        <p class="mb-1">Hormat kami,</p>
                        <div class="signature-line"></div>
                        <p class="fw-bold mt-1">BANGUNAN KEDIRI</p>
                        <p>Direktur</p>
                    </div>
                </div>
                
                <div class="mt-2 text-center">
                    <small class="text-muted">Dokumen ini sah dan dapat digunakan sebagai alat bukti pembayaran yang sah.</small>
                </div>
            </div>
            
            <div class="text-center mt-3 no-print">
                <button id="closeDocumentBtn" class="btn btn-secondary"><i class="fas fa-times me-1"></i>Tutup Dokumen</button>
                <button id="printDocumentPreviewBtn" class="btn btn-primary me-2"><i class="fas fa-print me-1"></i>Cetak</button>
                <button id="downloadPdfPreviewBtn" class="btn btn-pdf me-2"><i class="fas fa-file-pdf me-1"></i>Download PDF</button>
                <button id="sendWhatsAppFromPreviewBtn" class="btn btn-whatsapp"><i class="fab fa-whatsapp me-1"></i>Kirim ke WhatsApp</button>
            </div>
        </div>
    </div>

    <!-- Modal Kirim ke WhatsApp -->
    <div class="modal fade modal-whatsapp" id="whatsappModal" tabindex="-1" aria-labelledby="whatsappModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="whatsappModalLabel"><i class="fab fa-whatsapp me-2"></i>Kirim Dokumen ke WhatsApp</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4" id="whatsappLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Menyiapkan dokumen...</p>
                    </div>
                    
                    <div id="whatsappContent" style="display: none;">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Preview Dokumen:</h6>
                                <div id="imagePreview" class="text-center">
                                    <!-- Gambar akan ditampilkan di sini -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Penerima:</h6>
                                <div class="mb-3">
                                    <label class="form-label">Nomor WhatsApp</label>
                                    <input type="text" class="form-control" id="whatsappNumberInput" value="">
                                    <small class="form-text text-muted">Format: 62xxxxxxxxxxx (tanpa +)</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Pesan Tambahan</label>
                                    <textarea class="form-control" id="whatsappMessage" rows="4">Halo, berikut dokumen untuk proyek kami. Silakan review dan konfirmasi kembali. Terima kasih.</textarea>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <small>Dokumen akan dikirim sebagai gambar JPG. Pastikan nomor WhatsApp sudah benar.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-whatsapp" id="confirmSendWhatsAppBtn" style="display: none;">
                        <i class="fab fa-whatsapp me-1"></i>Kirim ke WhatsApp
                    </button>
                    <a href="#" class="btn btn-success" id="downloadImageBtn" style="display: none;" download="document.jpg">
                        <i class="fas fa-download me-1"></i>Download Gambar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container text-center">
            <p>&copy; 2025 Bangunan Kediri. Semua hak dilindungi.</p>
            <p>Jl. Sumur Pompa RT.06 RW.02 Desa Gabru Kecamatan Gurah Kediri | Telp/WA: 085746473070 | Email: bangunankediri2025@gmail.com</p>
            <p>Website: bangunankediri.com</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set tanggal hari ini sebagai default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('projectDate').value = today;
            
            // Inisialisasi variabel
            let items = [];
            let itemCounter = 1;
            let currentDocumentImage = null;
            let currentDocumentType = 'invoice'; // 'invoice' atau 'quotation'
            
            // Format angka ke format Rupiah
            function formatRupiah(angka) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(angka);
            }
            
            // Konversi angka ke angka Romawi
            function toRoman(num) {
                const romanNumerals = [
                    { value: 1000, symbol: 'M' },
                    { value: 900, symbol: 'CM' },
                    { value: 500, symbol: 'D' },
                    { value: 400, symbol: 'CD' },
                    { value: 100, symbol: 'C' },
                    { value: 90, symbol: 'XC' },
                    { value: 50, symbol: 'L' },
                    { value: 40, symbol: 'XL' },
                    { value: 10, symbol: 'X' },
                    { value: 9, symbol: 'IX' },
                    { value: 5, symbol: 'V' },
                    { value: 4, symbol: 'IV' },
                    { value: 1, symbol: 'I' }
                ];
                
                let result = '';
                for (const { value, symbol } of romanNumerals) {
                    while (num >= value) {
                        result += symbol;
                        num -= value;
                    }
                }
                return result;
            }
            
            // Generate nomor dokumen
            function generateDocumentNumber(projectNumber, documentType) {
                const now = new Date();
                const month = now.getMonth() + 1; // getMonth() returns 0-11
                const year = now.getFullYear();
                const monthRoman = toRoman(month);
                
                let docTypeCode = 'INV';
                if (documentType === 'quotation') {
                    docTypeCode = 'PNWR';
                }
                
                return `BK/${projectNumber}/${docTypeCode}/${monthRoman}/${year}`;
            }
            
            // Hitung total
            function calculateTotal() {
                let subtotal = 0;
                items.forEach(item => {
                    subtotal += item.total;
                });
                
                const tax = subtotal * 0.1; // PPN 10%
                const discount = 0; // Bisa ditambahkan fitur diskon nanti
                const total = subtotal + tax - discount;
                
                document.getElementById('subtotal').textContent = formatRupiah(subtotal);
                document.getElementById('tax').textContent = formatRupiah(tax);
                document.getElementById('discount').textContent = formatRupiah(discount);
                document.getElementById('total').textContent = formatRupiah(total);
                
                return { subtotal, tax, discount, total };
            }
            
            // Tambah item
            document.getElementById('itemForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const serviceType = document.getElementById('serviceType').value;
                const itemName = document.getElementById('itemName').value;
                const quantity = parseFloat(document.getElementById('quantity').value);
                const unit = document.getElementById('unit').value;
                const unitPrice = parseInt(document.getElementById('unitPrice').value);
                const total = quantity * unitPrice;
                
                const newItem = {
                    id: itemCounter++,
                    serviceType: serviceType,
                    name: itemName,
                    quantity: quantity,
                    unit: unit,
                    unitPrice: unitPrice,
                    total: total
                };
                
                items.push(newItem);
                updateItemsTable();
                calculateTotal();
                
                // Reset form
                document.getElementById('itemForm').reset();
                document.getElementById('itemName').focus();
            });
            
            // Update tabel items
            function updateItemsTable() {
                const itemsList = document.getElementById('itemsList');
                itemsList.innerHTML = '';
                
                items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.serviceType || '-'}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unit}</td>
                        <td>${formatRupiah(item.unitPrice)}</td>
                        <td>${formatRupiah(item.total)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-item" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    itemsList.appendChild(row);
                });
                
                // Tambah event listener untuk tombol hapus
                document.querySelectorAll('.delete-item').forEach(button => {
                    button.addEventListener('click', function() {
                        const itemId = parseInt(this.getAttribute('data-id'));
                        items = items.filter(item => item.id !== itemId);
                        updateItemsTable();
                        calculateTotal();
                    });
                });
            }
            
            // Hapus semua item
            document.getElementById('clearAllBtn').addEventListener('click', function() {
                if (confirm('Apakah Anda yakin ingin menghapus semua item?')) {
                    items = [];
                    updateItemsTable();
                    calculateTotal();
                }
            });
            
            // Toggle jenis dokumen
            document.getElementById('invoiceTypeBtn').addEventListener('click', function() {
                document.getElementById('invoiceTypeBtn').classList.add('active');
                document.getElementById('quotationTypeBtn').classList.remove('active');
                document.getElementById('documentType').value = 'invoice';
                currentDocumentType = 'invoice';
            });
            
            document.getElementById('quotationTypeBtn').addEventListener('click', function() {
                document.getElementById('quotationTypeBtn').classList.add('active');
                document.getElementById('invoiceTypeBtn').classList.remove('active');
                document.getElementById('documentType').value = 'quotation';
                currentDocumentType = 'quotation';
            });
            
            // Group items by service type
            function groupItemsByServiceType() {
                const grouped = {};
                
                items.forEach(item => {
                    const serviceType = item.serviceType || 'Lainnya';
                    if (!grouped[serviceType]) {
                        grouped[serviceType] = [];
                    }
                    grouped[serviceType].push(item);
                });
                
                return grouped;
            }
            
            // Generate dokumen
            document.getElementById('generateDocumentBtn').addEventListener('click', function() {
                if (items.length === 0) {
                    alert('Silakan tambahkan item terlebih dahulu!');
                    return;
                }
                
                // Validasi nomor proyek
                const projectNumber = document.getElementById('projectNumber').value;
                if (!projectNumber) {
                    alert('Silakan masukkan nomor proyek!');
                    document.getElementById('projectNumber').focus();
                    return;
                }
                
                // Isi data dokumen
                const clientName = document.getElementById('clientName').value || 'Nama Klien';
                document.getElementById('documentClientName').textContent = clientName;
                document.getElementById('documentClientSignatureName').textContent = `(${clientName})`;
                document.getElementById('documentClientAddress').textContent = document.getElementById('clientAddress').value || 'Alamat Klien';
                document.getElementById('documentClientPhone').textContent = 'Telp/WA: ' + (document.getElementById('clientPhone').value ? '0857' + document.getElementById('clientPhone').value : '-');
                document.getElementById('documentProjectName').textContent = document.getElementById('projectName').value || 'Nama Proyek';
                document.getElementById('documentProjectNumber').textContent = 'No. Proyek: ' + projectNumber;
                
                const projectDate = document.getElementById('projectDate').value;
                if (projectDate) {
                    const dateObj = new Date(projectDate);
                    const formattedDate = dateObj.toLocaleDateString('id-ID');
                    document.getElementById('documentProjectDate').textContent = 'Tanggal: ' + formattedDate;
                    document.getElementById('documentDate').textContent = formattedDate;
                    
                    // Hitung tanggal jatuh tempo (14 hari setelah invoice)
                    if (currentDocumentType === 'invoice') {
                        const dueDate = new Date(dateObj);
                        dueDate.setDate(dueDate.getDate() + 14);
                        document.getElementById('dueDate').textContent = dueDate.toLocaleDateString('id-ID');
                        document.getElementById('dueDateContainer').style.display = 'block';
                    } else {
                        document.getElementById('dueDateContainer').style.display = 'none';
                    }
                }
                
                // Generate nomor dokumen
                const docNumber = generateDocumentNumber(projectNumber, currentDocumentType);
                document.getElementById('documentNumber').textContent = docNumber;
                
                // Set judul dan badge dokumen
                if (currentDocumentType === 'invoice') {
                    document.getElementById('documentTitle').textContent = 'INVOICE';
                    document.getElementById('documentTypeBadge').textContent = 'INVOICE';
                    document.getElementById('documentTypeBadge').className = 'document-type-badge badge-invoice';
                } else {
                    document.getElementById('documentTitle').textContent = 'PENAWARAN HARGA';
                    document.getElementById('documentTypeBadge').textContent = 'PENAWARAN';
                    document.getElementById('documentTypeBadge').className = 'document-type-badge badge-quotation';
                }
                
                // Isi items dokumen dengan grouping berdasarkan jenis jasa
                const documentItemsList = document.getElementById('documentItemsList');
                documentItemsList.innerHTML = '';
                
                const groupedItems = groupItemsByServiceType();
                let rowCounter = 1;
                
                Object.keys(groupedItems).forEach(serviceType => {
                    const serviceItems = groupedItems[serviceType];
                    
                    // Tambah baris untuk jenis jasa
                    const serviceRow = document.createElement('tr');
                    serviceRow.className = 'service-group-header';
                    serviceRow.innerHTML = `
                        <td>${rowCounter}</td>
                        <td colspan="4"><strong>${serviceType}</strong></td>
                    `;
                    documentItemsList.appendChild(serviceRow);
                    
                    // Tambah item-item untuk jenis jasa ini
                    serviceItems.forEach(item => {
                        const itemRow = document.createElement('tr');
                        itemRow.className = 'item-row';
                        itemRow.innerHTML = `
                            <td></td>
                            <td>${item.name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit}</td>
                            <td>${formatRupiah(item.total)}</td>
                        `;
                        documentItemsList.appendChild(itemRow);
                    });
                    
                    rowCounter++;
                });
                
                // Hitung total dokumen
                const totals = calculateTotal();
                document.getElementById('documentSubtotal').textContent = formatRupiah(totals.subtotal);
                document.getElementById('documentTax').textContent = formatRupiah(totals.tax);
                document.getElementById('documentDiscount').textContent = formatRupiah(totals.discount);
                document.getElementById('documentTotal').textContent = formatRupiah(totals.total);
                
                // Tampilkan watermark saat generate dokumen
                document.querySelector('.watermark').style.display = 'block';
                
                // Tampilkan dokumen
                document.getElementById('invoiceSection').style.display = 'block';
                
                // Scroll ke dokumen
                document.getElementById('invoiceSection').scrollIntoView({ behavior: 'smooth' });
            });
            
            // Cetak dokumen dari preview
            document.getElementById('printDocumentPreviewBtn').addEventListener('click', function() {
                // Sembunyikan watermark saat print
                document.querySelector('.watermark').style.display = 'none';
                window.print();
                // Tampilkan kembali watermark setelah print
                setTimeout(() => {
                    document.querySelector('.watermark').style.display = 'block';
                }, 100);
            });
            
            // Cetak dokumen dari tabel utama
            document.getElementById('printDocumentBtn').addEventListener('click', function() {
                if (items.length === 0) {
                    alert('Silakan tambahkan item terlebih dahulu!');
                    return;
                }
                
                // Jika dokumen belum digenerate, generate dulu
                if (document.getElementById('invoiceSection').style.display === 'none') {
                    document.getElementById('generateDocumentBtn').click();
                }
                
                // Tunggu sebentar agar dokumen ditampilkan sebelum dicetak
                setTimeout(() => {
                    document.querySelector('.watermark').style.display = 'none';
                    window.print();
                    setTimeout(() => {
                        document.querySelector('.watermark').style.display = 'block';
                    }, 100);
                }, 500);
            });
            
            // Tutup dokumen
            document.getElementById('closeDocumentBtn').addEventListener('click', function() {
                document.getElementById('invoiceSection').style.display = 'none';
            });
            
            // Konversi dokumen menjadi gambar JPG
            function captureDocumentAsImage() {
                return new Promise((resolve, reject) => {
                    const documentElement = document.getElementById('invoiceSection');
                    
                    // Sembunyikan tombol-tombol yang tidak perlu di gambar
                    const noPrintElements = documentElement.querySelectorAll('.no-print');
                    noPrintElements.forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Sembunyikan watermark di gambar
                    const watermark = documentElement.querySelector('.watermark');
                    if (watermark) watermark.style.display = 'none';
                    
                    // Gunakan html2canvas untuk mengambil screenshot
                    html2canvas(documentElement, {
                        scale: 2, // Kualitas lebih tinggi
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    }).then(canvas => {
                        // Kembalikan tampilan elemen
                        noPrintElements.forEach(el => {
                            el.style.display = 'block';
                        });
                        if (watermark) watermark.style.display = 'block';
                        
                        // Konversi canvas ke data URL
                        const imageData = canvas.toDataURL('image/jpeg', 0.9);
                        resolve(imageData);
                    }).catch(error => {
                        // Kembalikan tampilan elemen jika error
                        noPrintElements.forEach(el => {
                            el.style.display = 'block';
                        });
                        if (watermark) watermark.style.display = 'block';
                        reject(error);
                    });
                });
            }
            
            // Generate PDF dari dokumen
            function generatePDF() {
                return new Promise((resolve, reject) => {
                    const documentElement = document.getElementById('invoiceSection');
                    
                    // Sembunyikan tombol-tombol yang tidak perlu di PDF
                    const noPrintElements = documentElement.querySelectorAll('.no-print');
                    noPrintElements.forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Sembunyikan watermark di PDF
                    const watermark = documentElement.querySelector('.watermark');
                    if (watermark) watermark.style.display = 'none';
                    
                    // Gunakan html2canvas untuk mengambil screenshot
                    html2canvas(documentElement, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    }).then(canvas => {
                        // Kembalikan tampilan elemen
                        noPrintElements.forEach(el => {
                            el.style.display = 'block';
                        });
                        if (watermark) watermark.style.display = 'block';
                        
                        // Buat PDF
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        
                        const imgWidth = 210; // Lebar A4 dalam mm
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        pdf.addImage(canvas.toDataURL('image/jpeg'), 'JPEG', 0, 0, imgWidth, imgHeight);
                        
                        // Simpan PDF
                        const docType = currentDocumentType === 'invoice' ? 'Invoice' : 'Penawaran';
                        const projectName = document.getElementById('projectName').value || 'Proyek';
                        const fileName = `${docType}_${projectName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
                        
                        pdf.save(fileName);
                        resolve();
                    }).catch(error => {
                        // Kembalikan tampilan elemen jika error
                        noPrintElements.forEach(el => {
                            el.style.display = 'block';
                        });
                        if (watermark) watermark.style.display = 'block';
                        reject(error);
                    });
                });
            }
            
            // Download PDF dari tombol utama
            document.getElementById('downloadPdfBtn').addEventListener('click', function() {
                if (items.length === 0) {
                    alert('Silakan tambahkan item terlebih dahulu!');
                    return;
                }
                
                // Jika dokumen belum digenerate, generate dulu
                if (document.getElementById('invoiceSection').style.display === 'none') {
                    document.getElementById('generateDocumentBtn').click();
                }
                
                // Tunggu sebentar agar dokumen ditampilkan sebelum membuat PDF
                setTimeout(() => {
                    generatePDF().catch(error => {
                        console.error('Error generating PDF:', error);
                        alert('Gagal membuat PDF. Silakan coba lagi.');
                    });
                }, 500);
            });
            
            // Download PDF dari preview
            document.getElementById('downloadPdfPreviewBtn').addEventListener('click', function() {
                generatePDF().catch(error => {
                    console.error('Error generating PDF:', error);
                    alert('Gagal membuat PDF. Silakan coba lagi.');
                });
            });
            
            // Tampilkan preview gambar di modal
            function showImagePreview(imageData) {
                const previewContainer = document.getElementById('imagePreview');
                previewContainer.innerHTML = `<img src="${imageData}" alt="Preview Dokumen" class="preview-image">`;
                
                // Simpan gambar untuk digunakan nanti
                currentDocumentImage = imageData;
                
                // Tampilkan tombol download
                const downloadBtn = document.getElementById('downloadImageBtn');
                const docType = currentDocumentType === 'invoice' ? 'Invoice' : 'Penawaran';
                const projectName = document.getElementById('projectName').value || 'Proyek';
                downloadBtn.href = imageData;
                downloadBtn.download = `${docType}_${projectName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.jpg`;
                downloadBtn.style.display = 'inline-block';
                
                // Tampilkan tombol kirim WhatsApp
                document.getElementById('confirmSendWhatsAppBtn').style.display = 'inline-block';
            }
            
            // Kirim ke WhatsApp dari tombol utama
            document.getElementById('sendWhatsAppBtn').addEventListener('click', function() {
                if (items.length === 0) {
                    alert('Silakan tambahkan item terlebih dahulu!');
                    return;
                }
                
                // Jika dokumen belum digenerate, generate dulu
                if (document.getElementById('invoiceSection').style.display === 'none') {
                    document.getElementById('generateDocumentBtn').click();
                }
                
                // Tampilkan modal
                const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
                whatsappModal.show();
                
                // Set nomor WhatsApp dari input
                const clientPhone = document.getElementById('clientPhone').value;
                document.getElementById('whatsappNumberInput').value = clientPhone ? '62857' + clientPhone : '';
                
                // Set pesan default
                const projectName = document.getElementById('projectName').value || 'Proyek';
                const clientName = document.getElementById('clientName').value || 'Klien';
                const docType = currentDocumentType === 'invoice' ? 'Invoice' : 'Penawaran Harga';
                document.getElementById('whatsappMessage').value = `Halo ${clientName}, berikut ${docType.toLowerCase()} untuk proyek "${projectName}".\n\nSilakan review dan konfirmasi kembali.\n\nTerima kasih.`;
                
                // Ambil screenshot dokumen
                captureDocumentAsImage().then(imageData => {
                    // Sembunyikan loading
                    document.getElementById('whatsappLoading').style.display = 'none';
                    
                    // Tampilkan konten
                    document.getElementById('whatsappContent').style.display = 'block';
                    
                    // Tampilkan preview
                    showImagePreview(imageData);
                }).catch(error => {
                    console.error('Error capturing document:', error);
                    alert('Gagal membuat gambar dokumen. Silakan coba lagi.');
                    whatsappModal.hide();
                });
            });
            
            // Kirim ke WhatsApp dari preview dokumen
            document.getElementById('sendWhatsAppFromPreviewBtn').addEventListener('click', function() {
                // Tampilkan modal
                const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
                whatsappModal.show();
                
                // Set nomor WhatsApp dari input
                const clientPhone = document.getElementById('clientPhone').value;
                document.getElementById('whatsappNumberInput').value = clientPhone ? '62857' + clientPhone : '';
                
                // Set pesan default
                const projectName = document.getElementById('projectName').value || 'Proyek';
                const clientName = document.getElementById('clientName').value || 'Klien';
                const docType = currentDocumentType === 'invoice' ? 'Invoice' : 'Penawaran Harga';
                document.getElementById('whatsappMessage').value = `Halo ${clientName}, berikut ${docType.toLowerCase()} untuk proyek "${projectName}".\n\nSilakan review dan konfirmasi kembali.\n\nTerima kasih.`;
                
                // Ambil screenshot dokumen
                captureDocumentAsImage().then(imageData => {
                    // Sembunyikan loading
                    document.getElementById('whatsappLoading').style.display = 'none';
                    
                    // Tampilkan konten
                    document.getElementById('whatsappContent').style.display = 'block';
                    
                    // Tampilkan preview
                    showImagePreview(imageData);
                }).catch(error => {
                    console.error('Error capturing document:', error);
                    alert('Gagal membuat gambar dokumen. Silakan coba lagi.');
                    whatsappModal.hide();
                });
            });
            
            // Konfirmasi kirim ke WhatsApp
            document.getElementById('confirmSendWhatsAppBtn').addEventListener('click', function() {
                const phoneNumber = document.getElementById('whatsappNumberInput').value;
                const message = document.getElementById('whatsappMessage').value;
                
                if (!phoneNumber) {
                    alert('Silakan masukkan nomor WhatsApp tujuan.');
                    return;
                }
                
                // Validasi nomor WhatsApp
                const cleanedPhone = phoneNumber.replace(/\D/g, '');
                if (cleanedPhone.length < 10) {
                    alert('Nomor WhatsApp tidak valid. Harap masukkan nomor yang benar.');
                    return;
                }
                
                // Download gambar terlebih dahulu
                const downloadLink = document.createElement('a');
                downloadLink.href = currentDocumentImage;
                const docType = currentDocumentType === 'invoice' ? 'Invoice' : 'Penawaran';
                const projectName = document.getElementById('projectName').value || 'Proyek';
                downloadLink.download = `${docType}_${projectName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.jpg`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                // Buka WhatsApp dengan nomor tujuan
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${cleanedPhone}?text=${encodedMessage}`;
                window.open(whatsappUrl, '_blank');
                
                // Tampilkan petunjuk
                setTimeout(() => {
                    alert('Dokumen telah diunduh sebagai gambar JPG.\n\nSilakan:\n1. Buka WhatsApp Web yang sudah terbuka\n2. Upload gambar dokumen yang telah diunduh\n3. Kirim pesan ke klien\n\nFile telah diunduh dengan nama: ' + downloadLink.download);
                }, 1000);
                
                // Tutup modal
                bootstrap.Modal.getInstance(document.getElementById('whatsappModal')).hide();
            });
            
            // Reset modal saat ditutup
            document.getElementById('whatsappModal').addEventListener('hidden.bs.modal', function() {
                document.getElementById('whatsappLoading').style.display = 'block';
                document.getElementById('whatsappContent').style.display = 'none';
                document.getElementById('confirmSendWhatsAppBtn').style.display = 'none';
                document.getElementById('downloadImageBtn').style.display = 'none';
                document.getElementById('imagePreview').innerHTML = '';
                currentDocumentImage = null;
            });
            
            // Initialize
            updateItemsTable();
        });
    </script>
</body>
</html>
