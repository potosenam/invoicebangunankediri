<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangunan Kediri - Pembuat RAB Otomatis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --whatsapp-color: #25D366;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .navbar {
            background-color: var(--primary-color);
        }
        
        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }
        
        .hero-section {
            background: linear-gradient(rgba(44, 62, 80, 0.8), rgba(44, 62, 80, 0.8)), url('https://images.unsplash.com/photo-1541888946425-d81bb19240f5?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center;
            background-size: cover;
            color: white;
            padding: 80px 0;
            text-align: center;
        }
        
        .card {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border: none;
        }
        
        .btn-success {
            background-color: #27ae60;
            border: none;
        }
        
        .btn-warning {
            background-color: #f39c12;
            border: none;
            color: white;
        }
        
        .btn-whatsapp {
            background-color: var(--whatsapp-color);
            border: none;
            color: white;
        }
        
        .btn-whatsapp:hover {
            background-color: #128C7E;
        }
        
        .btn-pdf {
            background-color: #e74c3c;
            border: none;
            color: white;
        }
        
        .btn-pdf:hover {
            background-color: #c0392b;
        }
        
        .table th {
            background-color: var(--light-color);
        }
        
        .total-section {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        /* Invoice Section - Format A4 dengan ukuran lebih kecil */
        .invoice-section {
            display: none;
            background-color: white;
            padding: 20px; /* Dikurangi dari 30px */
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 30px;
            width: 794px; /* Lebar A4 dalam pixel (210mm) */
            min-height: 1123px; /* Tinggi A4 dalam pixel (297mm) */
            margin-left: auto;
            margin-right: auto;
            position: relative;
            font-size: 0.9rem; /* Ukuran font lebih kecil */
        }
        
        .invoice-header {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px; /* Dikurangi */
            margin-bottom: 10px; /* Dikurangi */
        }
        
        .invoice-logo {
            max-width: 100px; /* Diperkecil dari 120px */
            height: auto;
        }
        
        .company-details {
            padding-left: 15px; /* Dikurangi */
        }
        
        .company-details h4 {
            font-size: 1.3rem; /* Dikurangi dari 1.5rem */
            font-weight: bold;
            margin-bottom: 2px; /* Dikurangi */
            color: #2c3e50;
        }
        
        .company-details p {
            margin-bottom: 0; /* Dikurangi */
            font-size: 0.8rem; /* Dikurangi dari 0.9rem */
            line-height: 1.1; /* Dikurangi dari 1.2 */
        }
        
        .document-type-badge {
            display: inline-block;
            padding: 3px 10px; /* Dikurangi */
            border-radius: 15px; /* Dikurangi */
            font-weight: bold;
            margin-bottom: 5px; /* Dikurangi */
            font-size: 0.85rem; /* Ditambahkan */
        }
        
        .badge-invoice {
            background-color: #3498db;
            color: white;
        }
        
        .badge-quotation {
            background-color: #2ecc71;
            color: white;
        }
        
        .signature-area {
            margin-top: 20px; /* Dikurangi dari 40px */
            padding-top: 10px; /* Dikurangi dari 15px */
            border-top: 1px dashed #ccc;
            position: relative;
            font-size: 0.85rem; /* Ditambahkan */
        }
        
        .signature-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px; /* Dikurangi dari 30px */
            position: relative;
        }
        
        .client-signature, .director-signature {
            width: 45%;
            text-align: center;
            position: relative;
        }
        
        .director-signature {
            position: relative;
        }
        
        .signature-line {
            width: 100%;
            height: 1px;
            background-color: #000;
            margin: 40px 0 5px 0; /* Dikurangi dari 50px */
        }
        
        /* Posisi stempel di atas TTD direktur, agak ke kiri */
        .stempel-over-signature {
            position: absolute;
            width: 100px; /* Diperkecil dari 130px */
            height: 100px; /* Diperkecil dari 130px */
            opacity: 0.9;
            z-index: 10;
            top: -15px; /* Dikurangi dari -20px */
            left: 15px; /* Dikurangi dari 20px */
            transform: rotate(-5deg);
        }
        
        /* Print Styles untuk A4 */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .invoice-section, .invoice-section * {
                visibility: visible;
            }
            
            .invoice-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 10mm; /* Dikurangi dari 15mm */
                box-shadow: none;
                page-break-after: always;
                font-size: 0.85rem !important; /* Ukuran font cetak lebih kecil */
            }
            
            .no-print {
                display: none !important;
            }
            
            /* Pastikan tabel tidak terpotong saat dicetak */
            table {
                page-break-inside: auto;
                font-size: 0.85rem !important; /* Ukuran font tabel saat cetak */
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            /* Menambahkan margin untuk printer */
            @page {
                size: A4;
                margin: 10mm; /* Dikurangi dari 15mm */
            }
        }
        
        footer {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            margin-top: 40px;
        }
        
        .feature-icon {
            font-size: 2.5rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }
        
        .section-title {
            position: relative;
            margin-bottom: 40px;
            text-align: center;
        }
        
        .section-title:after {
            content: '';
            display: block;
            width: 80px;
            height: 3px;
            background-color: var(--secondary-color);
            margin: 15px auto;
        }
        
        .watermark {
            position: absolute;
            opacity: 0.1;
            font-size: 100px; /* Diperkecil dari 120px */
            font-weight: bold;
            color: #ccc;
            transform: rotate(-45deg);
            top: 40%;
            left: 20%;
            z-index: 1;
            display: none;
        }
        
        /* Responsive untuk invoice */
        @media (max-width: 850px) {
            .invoice-section {
                width: 100%;
                min-height: auto;
                padding: 15px; /* Dikurangi */
            }
            
            .signature-container {
                flex-direction: column;
            }
            
            .client-signature, .director-signature {
                width: 100%;
                margin-bottom: 20px; /* Dikurangi */
            }
        }
        
        /* Loading spinner */
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .preview-image {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .document-type-selector {
            margin-bottom: 20px;
        }
        
        .document-type-selector .btn {
            margin-right: 10px;
        }
        
        .service-type-select {
            margin-bottom: 15px;
        }
        
        /* Styling untuk grouping item berdasarkan jasa */
        .service-group-header {
            background-color: #f8f9fa !important;
            font-weight: bold;
            border-left: 3px solid var(--secondary-color) !important;
        }
        
        .service-group-header td {
            padding-top: 8px !important; /* Dikurangi */
            padding-bottom: 2px !important; /* Dikurangi */
        }
        
        .item-row td {
            padding-left: 25px !important; /* Dikurangi dari 30px */
        }
        
        /* Mengurangi jarak antar baris di tabel */
        .table td, .table th {
            padding: 4px 6px !important; /* Dikurangi lagi */
            font-size: 0.85rem; /* Ukuran font tabel lebih kecil */
        }
        
        /* Mengurangi margin di bagian detail proyek dan klien */
        .row.mb-4 {
            margin-bottom: 0.5rem !important; /* Dikurangi lagi */
        }
        
        /* Mengurangi margin di bagian catatan dan total */
        .row.mt-4 {
            margin-top: 0.5rem !important; /* Dikurangi lagi */
        }
        
        /* Mengurangi padding di total section */
        .total-section {
            padding: 8px; /* Dikurangi lagi */
            font-size: 0.9rem; /* Ditambahkan */
        }
        
        /* Item counter */
        .item-counter {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
        }
        
        /* Form input untuk PPN, diskon, dan DP manual */
        .tax-discount-section {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        /* Input untuk PPN, diskon, dan DP */
        .tax-discount-inputs .form-control {
            font-size: 0.9rem;
            padding: 5px 10px;
        }
        
        /* Input untuk jumlah item per jasa */
        .item-details-row {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        
        /* Auto-numbering untuk items dalam group */
        .auto-number {
            display: inline-block;
            width: 20px;
            text-align: right;
            margin-right: 5px;
            font-weight: bold;
        }
        
        /* Styling untuk jenis jasa input manual */
        .service-type-manual {
            margin-bottom: 10px;
        }
        
        /* Catatan invoice - bukan text box */
        .document-notes {
            font-size: 0.8rem;
            line-height: 1.2;
            white-space: pre-line;
            margin-bottom: 5px;
        }
        
        /* Harga satuan di invoice - ditambahkan di sebelah kanan nama item */
        .item-with-price {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .item-name {
            flex: 1;
        }
        
        .unit-price {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.85rem;
            text-align: right;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-hard-hat me-2"></i>BANGUNAN KEDIRI</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#home"><i class="fas fa-home me-1"></i>Beranda</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#rabForm"><i class="fas fa-calculator me-1"></i>Buat RAB</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section" id="home">
        <div class="container">
            <h1 class="display-4">Pembuat RAB Otomatis</h1>
            <p class="lead">Hitung Rencana Anggaran Biaya (RAB) proyek konstruksi Anda dengan mudah dan cepat</p>
            <a href="#rabForm" class="btn btn-primary btn-lg mt-3"><i class="fas fa-calculator me-2"></i>Buat RAB Sekarang</a>
        </div>
    </div>

    <!-- Features Section -->
    <div class="container my-5">
        <div class="row text-center">
            <div class="col-md-4 mb-4">
                <div class="feature-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <h4>Cepat dan Mudah</h4>
                <p>Buat RAB dalam hitungan menit dengan sistem yang intuitif dan mudah digunakan.</p>
            </div>
            <div class="col-md-4 mb-4">
                <div class="feature-icon">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <h4>Invoice & Penawaran</h4>
                <p>Hasilkan invoice atau penawaran harga profesional format A4 yang siap dicetak.</p>
            </div>
            <div class="col-md-4 mb-4">
                <div class="feature-icon">
                    <i class="fab fa-whatsapp"></i>
                </div>
                <h4>Kirim ke WhatsApp</h4>
                <p>Kirim invoice langsung ke WhatsApp klien dalam format gambar JPG atau PDF.</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5" id="rabForm">
        <!-- Form Data Proyek -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-clipboard-list me-2"></i>Data Proyek
            </div>
            <div class="card-body">
                <form id="projectForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="projectNumber" class="form-label">Nomor Proyek <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="projectNumber" placeholder="BK001" required>
                            <small class="form-text text-muted">Contoh: BK001, BK002, dll.</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="projectName" class="form-label">Nama Proyek <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="projectName" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="clientName" class="form-label">Nama Klien <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="projectDate" class="form-label">Tanggal Proyek <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="projectDate" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="clientAddress" class="form-label">Alamat Klien <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="clientAddress" rows="3" required></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="clientPhone" class="form-label">Telepon/WhatsApp Klien <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">+62</span>
                                <input type="tel" class="form-control" id="clientPhone" placeholder="85746473070" required>
                            </div>
                            <small class="form-text text-muted">Contoh: 85746473070</small>
                        </div>
                    </div>
                    
                    <!-- Input untuk PPN, Diskon, dan DP Manual -->
                    <div class="row tax-discount-inputs">
                        <div class="col-md-3 mb-3">
                            <label for="ppnPercentage" class="form-label">PPN (%)</label>
                            <input type="number" class="form-control" id="ppnPercentage" value="10" min="0" max="100" step="0.1">
                            <small class="form-text text-muted">Persentase PPN</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="discountAmount" class="form-label">Diskon (Rp)</label>
                            <input type="number" class="form-control" id="discountAmount" value="0" min="0">
                            <small class="form-text text-muted">Nominal diskon</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="dpAmount" class="form-label">DP / Uang Muka (Rp)</label>
                            <input type="number" class="form-control" id="dpAmount" value="0" min="0">
                            <small class="form-text text-muted">Down Payment / Uang Muka</small>
                        </div>
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <button type="button" id="updateTaxDiscountBtn" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-sync-alt me-1"></i>Update
                            </button>
                        </div>
                    </div>
                    
                    <!-- Input untuk Catatan dan Syarat Pembayaran -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="projectNotes" class="form-label">Catatan untuk Dokumen</label>
                            <textarea class="form-control" id="projectNotes" rows="3">Pembayaran dapat dilakukan via transfer ke:
Bank: BCA Kediri
No. Rekening: 123-456-7890
Atas Nama: BANGUNAN KEDIRI

Pembayaran dianggap lunas setelah dana diterima.</textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="projectTerms" class="form-label">Syarat Pembayaran</label>
                            <textarea class="form-control" id="projectTerms" rows="3">50% diawal, 50% setelah pekerjaan selesai</textarea>
                        </div>
                    </div>
                    
                    <!-- Pilihan Jenis Dokumen -->
                    <div class="document-type-selector">
                        <label class="form-label">Jenis Dokumen <span class="text-danger">*</span></label>
                        <div>
                            <button type="button" class="btn btn-outline-primary active" id="invoiceTypeBtn">
                                <i class="fas fa-file-invoice me-1"></i>Invoice
                            </button>
                            <button type="button" class="btn btn-outline-success" id="quotationTypeBtn">
                                <i class="fas fa-file-contract me-1"></i>Penawaran Harga
                            </button>
                            <input type="hidden" id="documentType" value="invoice">
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Form Input Item dengan Sistem Grup Jasa -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-plus-circle me-2"></i>Input Item Pekerjaan (Kelompok Jasa)
            </div>
            <div class="card-body">
                <form id="itemForm">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="serviceType" class="form-label">Jenis Jasa <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="serviceType" placeholder="Contoh: Jasa Renovasi, Jasa Bangun Rumah, dll." required>
                            <small class="form-text text-muted">Ketik jenis jasa secara manual</small>
                        </div>
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Nama Item dalam Jasa ini:</label>
                            <div id="itemInputsContainer">
                                <!-- Input item akan ditambahkan dinamis di sini -->
                                <div class="item-input-row mb-2">
                                    <div class="input-group">
                                        <span class="input-group-text auto-number">1.</span>
                                        <input type="text" class="form-control item-name-input" placeholder="Nama item (mis: Pekerjaan pondasi)">
                                        <input type="number" class="form-control volume-input" placeholder="Volume" min="0" step="0.01" style="max-width: 100px;">
                                        <input type="text" class="form-control unit-input" placeholder="Satuan" style="max-width: 80px;">
                                        <input type="number" class="form-control price-input" placeholder="Harga Satuan" min="0" style="max-width: 150px;">
                                        <button type="button" class="btn btn-outline-danger remove-item-btn" style="display: none;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="addMoreItemBtn" class="btn btn-outline-secondary btn-sm mt-2">
                                <i class="fas fa-plus me-1"></i>Tambah Item Lain dalam Jasa Ini
                            </button>
                            <div class="item-counter">Item dalam jasa ini: <span id="itemCount">1</span></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-1"></i>Tambah Jasa & Item</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabel Daftar Item -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-tasks me-2"></i>Daftar Item Pekerjaan</span>
                <button id="clearAllBtn" class="btn btn-sm btn-danger"><i class="fas fa-trash me-1"></i>Hapus Semua</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="itemsTable">
                        <thead>
                            <tr>
                                <th width="5%">No</th>
                                <th width="25%">Jenis Jasa</th>
                                <th width="40%">Nama Item</th>
                                <th width="10%">Volume</th>
                                <th width="10%">Satuan</th>
                                <th width="10%">Total</th>
                                <th width="5%">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="itemsList">
                            <!-- Items will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Total Section dengan PPN, Diskon, dan DP Manual -->
                <div class="total-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="tax-discount-section">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="currentPpn" class="form-label">PPN (%)</label>
                                        <input type="number" class="form-control form-control-sm" id="currentPpn" value="10" min="0" max="100" step="0.1">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="currentDiscount" class="form-label">Diskon (Rp)</label>
                                        <input type="number" class="form-control form-control-sm" id="currentDiscount" value="0" min="0">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <label for="currentDP" class="form-label">DP / Uang Muka (Rp)</label>
                                        <input type="number" class="form-control form-control-sm" id="currentDP" value="0" min="0">
                                    </div>
                                </div>
                                <button type="button" id="applyTaxDiscountBtn" class="btn btn-outline-primary btn-sm mt-2">
                                    <i class="fas fa-check me-1"></i>Terapkan
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Subtotal:</span>
                                <span id="subtotal">Rp 0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span>PPN (<span id="ppnPercentDisplay">10</span>%):</span>
                                <span id="tax">Rp 0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Diskon:</span>
                                <span id="discount">Rp 0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1 fw-bold">
                                <span>DP / Uang Muka:</span>
                                <span id="dpDisplay">Rp 0</span>
                            </div>
                            <hr class="my-1">
                            <div class="d-flex justify-content-between fw-bold fs-5">
                                <span>Total:</span>
                                <span id="total">Rp 0</span>
                            </div>
                            <div class="d-flex justify-content-between mt-2" style="border-top: 1px dashed #ccc; padding-top: 5px;">
                                <span>Sisa yang harus dibayar:</span>
                                <span id="remainingDisplay" class="fw-bold" style="color: #e74c3c;">Rp 0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end mt-3">
                    <button id="generateDocumentBtn" class="btn btn-success me-2"><i class="fas fa-file-invoice me-1"></i>Buat Dokumen</button>
                    <button id="printDocumentBtn" class="btn btn-primary me-2"><i class="fas fa-print me-1"></i>Cetak</button>
                    <button id="downloadPdfBtn" class="btn btn-pdf me-2"><i class="fas fa-file-pdf me-1"></i>Download PDF</button>
                    <button id="sendWhatsAppBtn" class="btn btn-whatsapp"><i class="fab fa-whatsapp me-1"></i>Kirim ke WhatsApp</button>
                </div>
                
                <!-- Warning jika item terlalu banyak -->
                <div id="itemLimitWarning" class="alert alert-warning mt-3" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Peringatan:</strong> Jumlah item melebihi kapasitas 1 halaman A4. Disarankan untuk mengurangi jumlah item atau menggabungkan beberapa item.
                </div>
            </div>
        </div>

        <!-- Document Section - Format A4 yang lebih ringkas -->
        <div class="invoice-section" id="invoiceSection">
            <div class="watermark">BANGUNAN KEDIRI</div>
            
            <div class="invoice-header">
                <div class="row">
                    <div class="col-md-6 d-flex align-items-start">
                        <img src="img/logo.png" alt="Bangunan Kediri" class="invoice-logo">
                        <div class="company-details">
                            <h4 class="mt-0 mb-1">Bangunan Kediri</h4>
                            <p class="mb-0">Jl. Sumur pompa, RT.06 RW.02</p>
                            <p class="mb-0">Ds. Gabru Kec. Gurah Kediri</p>
                            <p class="mb-0">Telp/WA : 085746473070</p>
                            <p class="mb-0">bangunankediri2025@gmail.com</p>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div id="documentTypeBadge" class="document-type-badge badge-invoice">INVOICE</div>
                        <h2 id="documentTitle" class="text-uppercase mb-1" style="font-size: 1.5rem;">INVOICE</h2>
                        <p class="mb-0"><strong>No. Dokumen:</strong> <span id="documentNumber">BK/001/INV/I/2025</span></p>
                        <p class="mb-0"><strong>Tanggal:</strong> <span id="documentDate">01/01/2025</span></p>
                        <p class="mb-0" id="dueDateContainer"><strong>Jatuh Tempo:</strong> <span id="dueDate">15/01/2025</span></p>
                    </div>
                </div>
            </div>
            
            <div class="row mb-2">
                <div class="col-md-6">
                    <h5 class="mb-1" style="font-size: 1rem;">Kepada:</h5>
                    <p id="documentClientName" class="fw-bold mb-0">Nama Klien</p>
                    <p id="documentClientAddress" class="mb-0">Alamat Klien</p>
                    <p id="documentClientPhone" class="mb-0">Telp/WA: -</p>
                </div>
                <div class="col-md-6">
                    <h5 class="mb-1" style="font-size: 1rem;">Detail Proyek:</h5>
                    <p id="documentProjectName" class="fw-bold mb-0">Nama Proyek</p>
                    <p id="documentProjectNumber" class="mb-0">No. Proyek: -</p>
                    <p id="documentProjectDate" class="mb-0">Tanggal: -</p>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-bordered mb-2" id="documentTable" style="font-size: 0.8rem;">
                    <thead>
                        <tr>
                            <th width="5%">No</th>
                            <th width="40%">Jenis Jasa / Nama Item</th>
                            <th width="15%">Harga Satuan</th>
                            <th width="10%">Volume</th>
                            <th width="10%">Satuan</th>
                            <th width="20%">Total (Rp)</th>
                        </tr>
                    </thead>
                    <tbody id="documentItemsList">
                        <!-- Document items will be added here -->
                    </tbody>
                </table>
            </div>
            
            <div class="row mt-1">
                <div class="col-md-6">
                    <!-- Catatan Invoice - BUKAN TEXT BOX -->
                    <div class="mb-1">
                        <label class="form-label" style="font-size: 0.85rem;">Catatan:</label>
                        <div id="documentNotes" class="document-notes">
                            <!-- Catatan akan ditampilkan di sini -->
                        </div>
                    </div>
                    <!-- Syarat Pembayaran - BUKAN TEXT BOX -->
                    <div class="mb-1">
                        <label class="form-label" style="font-size: 0.85rem;">Syarat Pembayaran:</label>
                        <div id="documentTerms" class="document-notes">
                            <!-- Syarat pembayaran akan ditampilkan di sini -->
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="total-section" style="padding: 8px; font-size: 0.85rem;">
                        <div class="d-flex justify-content-between mb-0">
                            <span>Subtotal:</span>
                            <span id="documentSubtotal">Rp 0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-0">
                            <span>PPN (<span id="documentPpnPercent">10</span>%):</span>
                            <span id="documentTax">Rp 0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-0">
                            <span>Diskon:</span>
                            <span id="documentDiscount">Rp 0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-0 fw-bold">
                            <span>DP / Uang Muka:</span>
                            <span id="documentDP">Rp 0</span>
                        </div>
                        <hr class="my-1">
                        <div class="d-flex justify-content-between fw-bold" style="font-size: 1rem;">
                            <span>TOTAL PEMBAYARAN:</span>
                            <span id="documentTotal">Rp 0</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2" style="border-top: 1px dashed #ccc; padding-top: 5px;">
                            <span>Sisa yang harus dibayar:</span>
                            <span id="documentRemaining" class="fw-bold" style="color: #e74c3c;">Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Area Tanda Tangan Berdampingan dengan Stempel di TTD Manajemen -->
            <div class="signature-area">
                <div class="signature-container">
                    <!-- Tanda Tangan Klien -->
                    <div class="client-signature">
                        <p class="mb-0">Diterima oleh,</p>
                        <div class="signature-line"></div>
                        <p id="documentClientSignatureName" class="fw-bold mt-0">(Nama Klien)</p>
                        <p style="font-size: 0.8rem;">Klien</p>
                    </div>
                    
                    <!-- Tanda Tangan Manajemen dengan Stempel di atasnya -->
                    <div class="director-signature">
                        <!-- Stempel ditempatkan di atas tanda tangan manajemen, agak ke kiri -->
                        <img src="img/stempel.png" alt="Stempel Perusahaan" class="stempel-over-signature">
                        
                        <p class="mb-0">Hormat kami,</p>
                        <div class="signature-line"></div>
                        <p class="fw-bold mt-0">BANGUNAN KEDIRI</p>
                        <p style="font-size: 0.8rem;">Manajemen</p>
                    </div>
                </div>
                
                <div class="mt-1 text-center">
                    <small class="text-muted" style="font-size: 0.7rem;">Dokumen ini sah dan dapat digunakan sebagai alat bukti pembayaran yang sah.</small>
                </div>
            </div>
            
            <div class="text-center mt-2 no-print">
                <button id="closeDocumentBtn" class="btn btn-secondary btn-sm"><i class="fas fa-times me-1"></i>Tutup Dokumen</button>
                <button id="printDocumentPreviewBtn" class="btn btn-primary btn-sm me-2"><i class="fas fa-print me-1"></i>Cetak</button>
                <button id="downloadPdfPreviewBtn" class="btn btn-pdf btn-sm me-2"><i class="fas fa-file-pdf me-1"></i>Download PDF</button>
                <button id="sendWhatsAppFromPreviewBtn" class="btn btn-whatsapp btn-sm"><i class="fab fa-whatsapp me-1"></i>Kirim ke WhatsApp</button>
            </div>
        </div>
    </div>

    <!-- Modal Kirim ke WhatsApp -->
    <div class="modal fade modal-whatsapp" id="whatsappModal" tabindex="-1" aria-labelledby="whatsappModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="whatsappModalLabel"><i class="fab fa-whatsapp me-2"></i>Kirim Dokumen ke WhatsApp</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4" id="whatsappLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Menyiapkan dokumen...</p>
                    </div>
                    
                    <div id="whatsappContent" style="display: none;">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Preview Dokumen:</h6>
                                <div id="imagePreview" class="text-center">
                                    <!-- Gambar akan ditampilkan di sini -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Penerima:</h6>
                                <div class="mb-3">
                                    <label class="form-label">Nomor WhatsApp</label>
                                    <input type="text" class="form-control" id="whatsappNumberInput" value="">
                                    <small class="form-text text-muted">Format: 62xxxxxxxxxxx (tanpa +)</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Pesan Tambahan</label>
                                    <textarea class="form-control" id="whatsappMessage" rows="4">Halo, berikut dokumen untuk proyek kami. Silakan review dan konfirmasi kembali. Terima kasih.</textarea>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <small>Dokumen akan dikirim sebagai gambar JPG. Pastikan nomor WhatsApp sudah benar.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-whatsapp" id="confirmSendWhatsAppBtn" style="display: none;">
                        <i class="fab fa-whatsapp me-1"></i>Kirim ke WhatsApp
                    </button>
                    <a href="#" class="btn btn-success" id="downloadImageBtn" style="display: none;" download="document.jpg">
                        <i class="fas fa-download me-1"></i>Download Gambar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container text-center">
            <p>&copy; 2025 Bangunan Kediri. Semua hak dilindungi.</p>
            <p>Jl. Sumur Pompa RT.06 RW.02 Desa Gabru Kecamatan Gurah Kediri | Telp/WA: 085746473070 | Email: bangunankediri2025@gmail.com</p>
            <p>Website: bangunankediri.com</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set tanggal hari ini sebagai default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('projectDate').value = today;
            
            // Inisialisasi variabel
            let items = [];
            let itemCounter = 1;
            let currentDocumentImage = null;
            let currentDocumentType = 'invoice'; // 'invoice' atau 'quotation'
            let ppnPercentage = 10; // Default PPN 10%
            let discountAmount = 0; // Default diskon 0
            let dpAmount = 0; // Default DP 0
            
            // Format angka ke format Rupiah
            function formatRupiah(angka) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(angka);
            }
            
            // Konversi angka ke angka Romawi
            function toRoman(num) {
                const romanNumerals = [
                    { value: 1000, symbol: 'M' },
                    { value: 900, symbol: 'CM' },
                    { value: 500, symbol: 'D' },
                    { value: 400, symbol: 'CD' },
                    { value: 100, symbol: 'C' },
                    { value: 90, symbol: 'XC' },
                    { value: 50, symbol: 'L' },
                    { value: 40, symbol: 'XL' },
                    { value: 10, symbol: 'X' },
                    { value: 9, symbol: 'IX' },
                    { value: 5, symbol: 'V' },
                    { value: 4, symbol: 'IV' },
                    { value: 1, symbol: 'I' }
                ];
                
                let result = '';
                for (const { value, symbol } of romanNumerals) {
                    while (num >= value) {
                        result += symbol;
                        num -= value;
                    }
                }
                return result;
            }
            
            // Generate nomor dokumen
            function generateDocumentNumber(projectNumber, documentType) {
                const now = new Date();
                const month = now.getMonth() + 1; // getMonth() returns 0-11
                const year = now.getFullYear();
                const monthRoman = toRoman(month);
                
                let docTypeCode = 'INV';
                if (documentType === 'quotation') {
                    docTypeCode = 'PNWR';
                }
                
                return `BK/${projectNumber}/${docTypeCode}/${monthRoman}/${year}`;
            }
            
            // Hitung total dengan PPN, diskon, dan DP
            function calculateTotal() {
                let subtotal = 0;
                items.forEach(item => {
                    subtotal += item.total;
                });
                
                const tax = subtotal * (ppnPercentage / 100);
                const discount = discountAmount;
                const total = subtotal + tax - discount;
                const remaining = total - dpAmount;
                
                // Update display di tabel utama
                document.getElementById('subtotal').textContent = formatRupiah(subtotal);
                document.getElementById('tax').textContent = formatRupiah(tax);
                document.getElementById('discount').textContent = formatRupiah(discount);
                document.getElementById('total').textContent = formatRupiah(total);
                document.getElementById('ppnPercentDisplay').textContent = ppnPercentage;
                document.getElementById('dpDisplay').textContent = formatRupiah(dpAmount);
                document.getElementById('remainingDisplay').textContent = formatRupiah(remaining);
                
                return { subtotal, tax, discount, total, dpAmount, remaining };
            }
            
            // Update PPN, diskon, dan DP
            document.getElementById('applyTaxDiscountBtn').addEventListener('click', function() {
                ppnPercentage = parseFloat(document.getElementById('currentPpn').value) || 0;
                discountAmount = parseFloat(document.getElementById('currentDiscount').value) || 0;
                dpAmount = parseFloat(document.getElementById('currentDP').value) || 0;
                calculateTotal();
            });
            
            // Update PPN, diskon, dan DP dari form proyek
            document.getElementById('updateTaxDiscountBtn').addEventListener('click', function() {
                ppnPercentage = parseFloat(document.getElementById('ppnPercentage').value) || 0;
                discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
                dpAmount = parseFloat(document.getElementById('dpAmount').value) || 0;
                
                // Update nilai di total section
                document.getElementById('currentPpn').value = ppnPercentage;
                document.getElementById('currentDiscount').value = discountAmount;
                document.getElementById('currentDP').value = dpAmount;
                
                calculateTotal();
            });
            
            // Inisialisasi input item dinamis
            let itemInputCount = 1;
            const itemInputsContainer = document.getElementById('itemInputsContainer');
            const itemCountElement = document.getElementById('itemCount');
            
            function updateItemNumbers() {
                const rows = itemInputsContainer.querySelectorAll('.item-input-row');
                rows.forEach((row, index) => {
                    const autoNumber = row.querySelector('.auto-number');
                    autoNumber.textContent = `${index + 1}.`;
                    const removeBtn = row.querySelector('.remove-item-btn');
                    removeBtn.style.display = rows.length > 1 ? 'block' : 'none';
                });
                itemCountElement.textContent = rows.length;
            }
            
            // Tambah input item baru
            document.getElementById('addMoreItemBtn').addEventListener('click', function() {
                const newRow = document.createElement('div');
                newRow.className = 'item-input-row mb-2';
                newRow.innerHTML = `
                    <div class="input-group">
                        <span class="input-group-text auto-number">${itemInputCount + 1}.</span>
                        <input type="text" class="form-control item-name-input" placeholder="Nama item (mis: Pekerjaan pondasi)" required>
                        <input type="number" class="form-control volume-input" placeholder="Volume" min="0" step="0.01" required style="max-width: 100px;">
                        <input type="text" class="form-control unit-input" placeholder="Satuan" required style="max-width: 80px;">
                        <input type="number" class="form-control price-input" placeholder="Harga Satuan" min="0" required style="max-width: 150px;">
                        <button type="button" class="btn btn-outline-danger remove-item-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                itemInputsContainer.appendChild(newRow);
                itemInputCount++;
                updateItemNumbers();
                
                // Tambah event listener untuk tombol hapus
                newRow.querySelector('.remove-item-btn').addEventListener('click', function() {
                    newRow.remove();
                    itemInputCount--;
                    updateItemNumbers();
                });
            });
            
            // Tambah item (kelompok jasa)
            document.getElementById('itemForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const serviceType = document.getElementById('serviceType').value;
                if (!serviceType) {
                    alert('Silakan ketik jenis jasa terlebih dahulu!');
                    return;
                }
                
                // Ambil semua input item
                const itemRows = itemInputsContainer.querySelectorAll('.item-input-row');
                let hasValidItem = false;
                
                itemRows.forEach(row => {
                    const itemName = row.querySelector('.item-name-input').value;
                    const quantity = parseFloat(row.querySelector('.volume-input').value);
                    const unit = row.querySelector('.unit-input').value;
                    const unitPrice = parseInt(row.querySelector('.price-input').value);
                    
                    if (itemName && !isNaN(quantity) && unit && !isNaN(unitPrice)) {
                        const total = quantity * unitPrice;
                        
                        const newItem = {
                            id: itemCounter++,
                            serviceType: serviceType,
                            name: itemName,
                            quantity: quantity,
                            unit: unit,
                            unitPrice: unitPrice,
                            total: total
                        };
                        
                        items.push(newItem);
                        hasValidItem = true;
                    }
                });
                
                if (!hasValidItem) {
                    alert('Silakan isi setidaknya satu item dengan data yang lengkap!');
                    return;
                }
                
                updateItemsTable();
                calculateTotal();
                
                // Reset form
                document.getElementById('itemForm').reset();
                itemInputsContainer.innerHTML = `
                    <div class="item-input-row mb-2">
                        <div class="input-group">
                            <span class="input-group-text auto-number">1.</span>
                            <input type="text" class="form-control item-name-input" placeholder="Nama item (mis: Pekerjaan pondasi)" required>
                            <input type="number" class="form-control volume-input" placeholder="Volume" min="0" step="0.01" required style="max-width: 100px;">
                            <input type="text" class="form-control unit-input" placeholder="Satuan" required style="max-width: 80px;">
                            <input type="number" class="form-control price-input" placeholder="Harga Satuan" min="0" required style="max-width: 150px;">
                            <button type="button" class="btn btn-outline-danger remove-item-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                itemInputCount = 1;
                updateItemNumbers();
                document.getElementById('serviceType').focus();
            });
            
            // Update tabel items dengan pengelompokan
            function updateItemsTable() {
                const itemsList = document.getElementById('itemsList');
                itemsList.innerHTML = '';
                
                // Kelompokkan item berdasarkan jenis jasa
                const groupedItems = {};
                items.forEach(item => {
                    if (!groupedItems[item.serviceType]) {
                        groupedItems[item.serviceType] = [];
                    }
                    groupedItems[item.serviceType].push(item);
                });
                
                let rowNumber = 1;
                
                // Tampilkan item per kelompok jasa
                Object.keys(groupedItems).forEach(serviceType => {
                    const serviceItems = groupedItems[serviceType];
                    
                    // Baris untuk header jenis jasa
                    const serviceRow = document.createElement('tr');
                    serviceRow.className = 'service-group-header';
                    serviceRow.innerHTML = `
                        <td>${rowNumber}</td>
                        <td colspan="5"><strong>${serviceType}</strong></td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger delete-service" data-service="${serviceType}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    itemsList.appendChild(serviceRow);
                    rowNumber++;
                    
                    // Baris untuk setiap item dalam jasa ini
                    serviceItems.forEach((item, index) => {
                        const itemRow = document.createElement('tr');
                        itemRow.className = 'item-row';
                        itemRow.innerHTML = `
                            <td></td>
                            <td></td>
                            <td>${item.name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit}</td>
                            <td>${formatRupiah(item.total)}</td>
                            <td>
                                <button class="btn btn-sm btn-danger delete-item" data-id="${item.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        itemsList.appendChild(itemRow);
                    });
                });
                
                // Update nomor urut
                const allRows = itemsList.querySelectorAll('tr');
                let counter = 1;
                allRows.forEach(row => {
                    if (!row.classList.contains('item-row')) {
                        const td = row.querySelector('td');
                        if (td) td.textContent = counter++;
                    }
                });
                
                // Tambah event listener untuk tombol hapus
                document.querySelectorAll('.delete-item').forEach(button => {
                    button.addEventListener('click', function() {
                        const itemId = parseInt(this.getAttribute('data-id'));
                        items = items.filter(item => item.id !== itemId);
                        updateItemsTable();
                        calculateTotal();
                    });
                });
                
                // Tambah event listener untuk tombol hapus jasa
                document.querySelectorAll('.delete-service').forEach(button => {
                    button.addEventListener('click', function() {
                        const serviceType = this.getAttribute('data-service');
                        if (confirm(`Hapus semua item dalam jasa "${serviceType}"?`)) {
                            items = items.filter(item => item.serviceType !== serviceType);
                            updateItemsTable();
                            calculateTotal();
                        }
                    });
                });
                
                // Cek apakah item terlalu banyak untuk 1 halaman A4
                checkItemLimit();
            }
            
            // Cek batas item untuk 1 halaman A4
            function checkItemLimit() {
                const warningElement = document.getElementById('itemLimitWarning');
                // Perkiraan: maksimal 15 baris (termasuk header jasa) untuk muat 1 halaman A4
                const estimatedRows = items.length + Object.keys(groupItemsByServiceType()).length;
                
                if (estimatedRows > 15) {
                    warningElement.style.display = 'block';
                } else {
                    warningElement.style.display = 'none';
                }
            }
            
            // Hapus semua item
            document.getElementById('clearAllBtn').addEventListener('click', function() {
                if (confirm('Apakah Anda yakin ingin menghapus semua item?')) {
                    items = [];
                    updateItemsTable();
                    calculateTotal();
                }
            });
            
            // Toggle jenis dokumen
            document.getElementById('invoiceTypeBtn').addEventListener('click', function() {
                document.getElementById('invoiceTypeBtn').classList.add('active');
                document.getElementById('quotationTypeBtn').classList.remove('active');
                document.getElementById('documentType').value = 'invoice';
                currentDocumentType = 'invoice';
            });
            
            document.getElementById('quotationTypeBtn').addEventListener('click', function() {
                document.getElementById('quotationTypeBtn').classList.add('active');
                document.getElementById('invoiceTypeBtn').classList.remove('active');
                document.getElementById('documentType').value = 'quotation';
                currentDocumentType = 'quotation';
            });
            
            // Group items by service type
            function groupItemsByServiceType() {
                const grouped = {};
                
                items.forEach(item => {
                    const serviceType = item.serviceType || 'Lainnya';
                    if (!grouped[serviceType]) {
                        grouped[serviceType] = [];
                    }
                    grouped[serviceType].push(item);
                });
                
                return grouped;
            }
            
            // Generate dokumen dengan pengelompokan dan harga satuan sesuai urutan baru
            document.getElementById('generateDocumentBtn').addEventListener('click', function() {
                if (items.length === 0) {
                    alert('Silakan tambahkan item terlebih dahulu!');
                    return;
                }
                
                // Validasi nomor proyek
                const projectNumber = document.getElementById('projectNumber').value;
                if (!projectNumber) {
                    alert('Silakan masukkan nomor proyek!');
                    document.getElementById('projectNumber').focus();
                    return;
                }
                
                // Update nilai PPN, Diskon, dan DP dari form data proyek
                ppnPercentage = parseFloat(document.getElementById('ppnPercentage').value) || 0;
                discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
                dpAmount = parseFloat(document.getElementById('dpAmount').value) || 0;
                
                // Update nilai di total section (jika ada)
                document.getElementById('currentPpn').value = ppnPercentage;
                document.getElementById('currentDiscount').value = discountAmount;
                document.getElementById('currentDP').value = dpAmount;
                
                // Cek apakah item terlalu banyak
                checkItemLimit();
                
                // Isi data dokumen
                const clientName = document.getElementById('clientName').value || 'Nama Klien';
                document.getElementById('documentClientName').textContent = clientName;
                document.getElementById('documentClientSignatureName').textContent = `(${clientName})`;
                document.getElementById('documentClientAddress').textContent = document.getElementById('clientAddress').value || 'Alamat Klien';
                document.getElementById('documentClientPhone').textContent = 'Telp/WA: ' + (document.getElementById('clientPhone').value ? '0857' + document.getElementById('clientPhone').value : '-');
                document.getElementById('documentProjectName').textContent = document.getElementById('projectName').value || 'Nama Proyek';
                document.getElementById('documentProjectNumber').textContent = 'No. Proyek: ' + projectNumber;
                
                const projectDate = document.getElementById('projectDate').value;
                if (projectDate) {
                    const dateObj = new Date(projectDate);
                    const formattedDate = dateObj.toLocaleDateString('id-ID');
                    document.getElementById('documentProjectDate').textContent = 'Tanggal: ' + formattedDate;
                    document.getElementById('documentDate').textContent = formattedDate;
                    
                    // Hitung tanggal jatuh tempo (14 hari setelah invoice)
                    if (currentDocumentType === 'invoice') {
                        const dueDate = new Date(dateObj);
                        dueDate.setDate(dueDate.getDate() + 14);
                        document.getElementById('dueDate').textContent = dueDate.toLocaleDateString('id-ID');
                        document.getElementById('dueDateContainer').style.display = 'block';
                    } else {
                        document.getElementById('dueDateContainer').style.display = 'none';
                    }
                }
                
                // Generate nomor dokumen
                const docNumber = generateDocumentNumber(projectNumber, currentDocumentType);
                document.getElementById('documentNumber').textContent = docNumber;
                
                // Set judul dan badge dokumen
                if (currentDocumentType === 'invoice') {
                    document.getElementById('documentTitle').textContent = 'INVOICE';
                    document.getElementById('documentTypeBadge').textContent = 'INVOICE';
                    document.getElementById('documentTypeBadge').className = 'document-type-badge badge-invoice';
                } else {
                    document.getElementById('documentTitle').textContent = 'PENAWARAN HARGA';
                    document.getElementById('documentTypeBadge').textContent = 'PENAWARAN';
                    document.getElementById('documentTypeBadge').className = 'document-type-badge badge-quotation';
                }
                
                // Isi catatan dan syarat pembayaran dari form (BUKAN TEXT BOX)
                const projectNotes = document.getElementById('projectNotes').value;
                const projectTerms = document.getElementById('projectTerms').value;
                document.getElementById('documentNotes').textContent = projectNotes;
                document.getElementById('documentTerms').textContent = projectTerms;
                
                // Isi items dokumen dengan grouping berdasarkan jenis jasa dan harga satuan sesuai urutan baru
                const documentItemsList = document.getElementById('documentItemsList');
                documentItemsList.innerHTML = '';
                
                const groupedItems = groupItemsByServiceType();
                let rowCounter = 1;
                
                Object.keys(groupedItems).forEach(serviceType => {
                    const serviceItems = groupedItems[serviceType];
                    
                    // Tambah baris untuk jenis jasa
                    const serviceRow = document.createElement('tr');
                    serviceRow.className = 'service-group-header';
                    serviceRow.innerHTML = `
                        <td>${rowCounter}</td>
                        <td colspan="5"><strong>${serviceType}</strong></td>
                    `;
                    documentItemsList.appendChild(serviceRow);
                    
                    // Tambah item-item untuk jenis jasa ini dengan urutan baru
                    serviceItems.forEach(item => {
                        const itemRow = document.createElement('tr');
                        itemRow.className = 'item-row';
                        itemRow.innerHTML = `
                            <td></td>
                            <td>${item.name}</td>
                            <td>${formatRupiah(item.unitPrice)}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit}</td>
                            <td>${formatRupiah(item.total)}</td>
                        `;
                        documentItemsList.appendChild(itemRow);
                    });
                    
                    rowCounter++;
                });
                
                // Hitung total dokumen
                const totals = calculateTotal();
                document.getElementById('documentSubtotal').textContent = formatRupiah(totals.subtotal);
                document.getElementById('documentTax').textContent = formatRupiah(totals.tax);
                document.getElementById('documentDiscount').textContent = formatRupiah(totals.discount);
                document.getElementById('documentTotal').textContent = formatRupiah(totals.total);
                document.getElementById('documentDP').textContent = formatRupiah(totals.dpAmount);
                document.getElementById('documentRemaining').textContent = formatRupiah(totals.remaining);
                document.getElementById('documentPpnPercent').textContent = ppnPercentage;
                
                // Tampilkan watermark saat generate dokumen
                document.querySelector('.watermark').style.display = 'block';
                
                // Tampilkan dokumen
                document.getElementById('invoiceSection').style.display = 'block';
                
                // Scroll ke dokumen
                document.getElementById('invoiceSection').scrollIntoView({ behavior: 'smooth' });
            });
            
            // Cetak dokumen dari preview
            document.getElementById('printDocumentPreviewBtn').addEventListener('click', function() {
                // Sembunyikan watermark saat print
                document.querySelector('.watermark').style.display = 'none';
                // Sembunyikan tombol-tombol
                document.querySelectorAll('.no-print').forEach(el => {
                    el.style.display = 'none';
                });
                window.print();
                // Tampilkan kembali watermark setelah print
                setTimeout(() => {
                    document.querySelector('.watermark').style.display = 'block';
                    document.querySelectorAll('.no-print').forEach(el => {
                        el.style.display = 'block';
                    });
                }, 100);
            });
            
            // Cetak dokumen dari tabel utama
            document.getElementById('printDocumentBtn').addEventListener('click', function() {
                if (items.length === 0) {
                    alert('Silakan tambahkan item terlebih dahulu!');
                    return;
                }
                
                // Jika dokumen belum digenerate, generate dulu
                if (document.getElementById('invoiceSection').style.display === 'none') {
                    document.getElementById('generateDocumentBtn').click();
                }
                
                // Tunggu sebentar agar dokumen ditampilkan sebelum dicetak
                setTimeout(() => {
                    document.querySelector('.watermark').style.display = 'none';
                    document.querySelectorAll('.no-print').forEach(el => {
                        el.style.display = 'none';
                    });
                    window.print();
                    setTimeout(() => {
                        document.querySelector('.watermark').style.display = 'block';
                        document.querySelectorAll('.no-print').forEach(el => {
                            el.style.display = 'block';
                        });
                    }, 100);
                }, 500);
            });
            
            // Tutup dokumen
            document.getElementById('closeDocumentBtn').addEventListener('click', function() {
                document.getElementById('invoiceSection').style.display = 'none';
            });
            
            // Konversi dokumen menjadi gambar JPG
            function captureDocumentAsImage() {
                return new Promise((resolve, reject) => {
                    const documentElement = document.getElementById('invoiceSection');
                    
                    // Sembunyikan tombol-tombol yang tidak perlu di gambar
                    const noPrintElements = documentElement.querySelectorAll('.no-print');
                    noPrintElements.forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Sembunyikan watermark di gambar
                    const watermark = documentElement.querySelector('.watermark');
                    if (watermark) watermark.style.display = 'none';
                    
                    // Atur ukuran font lebih kecil untuk gambar
                    documentElement.style.fontSize = '0.8rem';
                    
                    // Gunakan html2canvas untuk mengambil screenshot
                    html2canvas(documentElement, {
                        scale: 1.5, // Kualitas lebih tinggi
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    }).then(canvas => {
                        // Kembalikan tampilan elemen
                        noPrintElements.forEach(el => {
                            el.style.display = 'block';
                        });
                        if (watermark) watermark.style.display = 'block';
                        documentElement.style.fontSize = '';
                        
                        // Konversi canvas ke data URL
                        const imageData = canvas.toDataURL('image/jpeg', 0.9);
                        resolve(imageData);
                    }).catch(error => {
                        // Kembalikan tampilan elemen jika error
                        noPrintElements.forEach(el => {
                            el.style.display = 'block';
                        });
                        if (watermark) watermark.style.display = 'block';
                        documentElement.style.fontSize = '';
                        reject(error);
                    });
                });
            }
            
            // Generate PDF dari dokumen (selalu 1 halaman)
            function generatePDF() {
                return new Promise((resolve, reject) => {
                    const documentElement = document.getElementById('invoiceSection');
                    
                    // Sembunyikan tombol-tombol yang tidak perlu di PDF
                    const noPrintElements = documentElement.querySelectorAll('.no-print');
                    noPrintElements.forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Sembunyikan watermark di PDF
                    const watermark = documentElement.querySelector('.watermark');
                    if (watermark) watermark.style.display = 'none';
                    
                    // Atur ukuran font lebih kecil untuk PDF
                    documentElement.style.fontSize = '0.75rem';
                    
                    // Gunakan html2canvas untuk mengambil screenshot
                    html2canvas(documentElement, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    }).then(canvas => {
                        // Kembalikan tampilan elemen
                        noPrintElements.forEach(el => {
                            el.style.display = 'block';
                        });
                        if (watermark) watermark.style.display = 'block';
                        documentElement.style.fontSize = '';
                        
                        // Buat PDF
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        
                        // Hitung dimensi gambar agar pas di A4
                        const imgWidth = 190; // Lebar sedikit dikurangi untuk margin
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        // Pastikan gambar tidak melebihi tinggi A4
                        const maxHeight = 280; // Tinggi maksimal untuk A4 dengan margin
                        const finalHeight = imgHeight > maxHeight ? maxHeight : imgHeight;
                        const finalWidth = (canvas.width * finalHeight) / canvas.height;
                        
                        // Hitung posisi tengah
                        const xPos = (210 - finalWidth) / 2;
                        
                        pdf.addImage(canvas.toDataURL('image/jpeg'), 'JPEG', xPos, 10, finalWidth, finalHeight);
                        
                        // Simpan PDF
                        const docType = currentDocumentType === 'invoice' ? 'Invoice' : 'Penawaran';
                        const projectName = document.getElementById('projectName').value || 'Proyek';
                        const fileName = `${docType}_${projectName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
                        
                        pdf.save(fileName);
                        resolve();
                    }).catch(error => {
                        // Kembalikan tampilan elemen jika error
                        noPrintElements.forEach(el => {
                            el.style.display = 'block';
                        });
                        if (watermark) watermark.style.display = 'block';
                        documentElement.style.fontSize = '';
                        reject(error);
                    });
                });
            }
            
            // Download PDF dari tombol utama
            document.getElementById('downloadPdfBtn').addEventListener('click', function() {
                if (items.length === 0) {
                    alert('Silakan tambahkan item terlebih dahulu!');
                    return;
                }
                
                // Jika dokumen belum digenerate, generate dulu
                if (document.getElementById('invoiceSection').style.display === 'none') {
                    document.getElementById('generateDocumentBtn').click();
                }
                
                // Tunggu sebentar agar dokumen ditampilkan sebelum membuat PDF
                setTimeout(() => {
                    generatePDF().catch(error => {
                        console.error('Error generating PDF:', error);
                        alert('Gagal membuat PDF. Silakan coba lagi.');
                    });
                }, 500);
            });
            
            // Download PDF dari preview
            document.getElementById('downloadPdfPreviewBtn').addEventListener('click', function() {
                generatePDF().catch(error => {
                    console.error('Error generating PDF:', error);
                    alert('Gagal membuat PDF. Silakan coba lagi.');
                });
            });
            
            // Tampilkan preview gambar di modal
            function showImagePreview(imageData) {
                const previewContainer = document.getElementById('imagePreview');
                previewContainer.innerHTML = `<img src="${imageData}" alt="Preview Dokumen" class="preview-image">`;
                
                // Simpan gambar untuk digunakan nanti
                currentDocumentImage = imageData;
                
                // Tampilkan tombol download
                const downloadBtn = document.getElementById('downloadImageBtn');
                const docType = currentDocumentType === 'invoice' ? 'Invoice' : 'Penawaran';
                const projectName = document.getElementById('projectName').value || 'Proyek';
                downloadBtn.href = imageData;
                downloadBtn.download = `${docType}_${projectName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.jpg`;
                downloadBtn.style.display = 'inline-block';
                
                // Tampilkan tombol kirim WhatsApp
                document.getElementById('confirmSendWhatsAppBtn').style.display = 'inline-block';
            }
            
            // Kirim ke WhatsApp dari tombol utama
            document.getElementById('sendWhatsAppBtn').addEventListener('click', function() {
                if (items.length === 0) {
                    alert('Silakan tambahkan item terlebih dahulu!');
                    return;
                }
                
                // Jika dokumen belum digenerate, generate dulu
                if (document.getElementById('invoiceSection').style.display === 'none') {
                    document.getElementById('generateDocumentBtn').click();
                }
                
                // Tampilkan modal
                const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
                whatsappModal.show();
                
                // Set nomor WhatsApp dari input
                const clientPhone = document.getElementById('clientPhone').value;
                document.getElementById('whatsappNumberInput').value = clientPhone ? '62857' + clientPhone : '';
                
                // Set pesan default
                const projectName = document.getElementById('projectName').value || 'Proyek';
                const clientName = document.getElementById('clientName').value || 'Klien';
                const docType = currentDocumentType === 'invoice' ? 'Invoice' : 'Penawaran Harga';
                document.getElementById('whatsappMessage').value = `Halo ${clientName}, berikut ${docType.toLowerCase()} untuk proyek "${projectName}".\n\nSilakan review dan konfirmasi kembali.\n\nTerima kasih.`;
                
                // Ambil screenshot dokumen
                captureDocumentAsImage().then(imageData => {
                    // Sembunyikan loading
                    document.getElementById('whatsappLoading').style.display = 'none';
                    
                    // Tampilkan konten
                    document.getElementById('whatsappContent').style.display = 'block';
                    
                    // Tampilkan preview
                    showImagePreview(imageData);
                }).catch(error => {
                    console.error('Error capturing document:', error);
                    alert('Gagal membuat gambar dokumen. Silakan coba lagi.');
                    whatsappModal.hide();
                });
            });
            
            // Kirim ke WhatsApp dari preview dokumen
            document.getElementById('sendWhatsAppFromPreviewBtn').addEventListener('click', function() {
                // Tampilkan modal
                const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
                whatsappModal.show();
                
                // Set nomor WhatsApp dari input
                const clientPhone = document.getElementById('clientPhone').value;
                document.getElementById('whatsappNumberInput').value = clientPhone ? '62857' + clientPhone : '';
                
                // Set pesan default
                const projectName = document.getElementById('projectName').value || 'Proyek';
                const clientName = document.getElementById('clientName').value || 'Klien';
                const docType = currentDocumentType === 'invoice' ? 'Invoice' : 'Penawaran Harga';
                document.getElementById('whatsappMessage').value = `Halo ${clientName}, berikut ${docType.toLowerCase()} untuk proyek "${projectName}".\n\nSilakan review dan konfirmasi kembali.\n\nTerima kasih.`;
                
                // Ambil screenshot dokumen
                captureDocumentAsImage().then(imageData => {
                    // Sembunyikan loading
                    document.getElementById('whatsappLoading').style.display = 'none';
                    
                    // Tampilkan konten
                    document.getElementById('whatsappContent').style.display = 'block';
                    
                    // Tampilkan preview
                    showImagePreview(imageData);
                }).catch(error => {
                    console.error('Error capturing document:', error);
                    alert('Gagal membuat gambar dokumen. Silakan coba lagi.');
                    whatsappModal.hide();
                });
            });
            
            // Konfirmasi kirim ke WhatsApp
            document.getElementById('confirmSendWhatsAppBtn').addEventListener('click', function() {
                const phoneNumber = document.getElementById('whatsappNumberInput').value;
                const message = document.getElementById('whatsappMessage').value;
                
                if (!phoneNumber) {
                    alert('Silakan masukkan nomor WhatsApp tujuan.');
                    return;
                }
                
                // Validasi nomor WhatsApp
                const cleanedPhone = phoneNumber.replace(/\D/g, '');
                if (cleanedPhone.length < 10) {
                    alert('Nomor WhatsApp tidak valid. Harap masukkan nomor yang benar.');
                    return;
                }
                
                // Download gambar terlebih dahulu
                const downloadLink = document.createElement('a');
                downloadLink.href = currentDocumentImage;
                const docType = currentDocumentType === 'invoice' ? 'Invoice' : 'Penawaran';
                const projectName = document.getElementById('projectName').value || 'Proyek';
                downloadLink.download = `${docType}_${projectName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.jpg`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                // Buka WhatsApp dengan nomor tujuan
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${cleanedPhone}?text=${encodedMessage}`;
                window.open(whatsappUrl, '_blank');
                
                // Tampilkan petunjuk
                setTimeout(() => {
                    alert('Dokumen telah diunduh sebagai gambar JPG.\n\nSilakan:\n1. Buka WhatsApp Web yang sudah terbuka\n2. Upload gambar dokumen yang telah diunduh\n3. Kirim pesan ke klien\n\nFile telah diunduh dengan nama: ' + downloadLink.download);
                }, 1000);
                
                // Tutup modal
                bootstrap.Modal.getInstance(document.getElementById('whatsappModal')).hide();
            });
            
            // Reset modal saat ditutup
            document.getElementById('whatsappModal').addEventListener('hidden.bs.modal', function() {
                document.getElementById('whatsappLoading').style.display = 'block';
                document.getElementById('whatsappContent').style.display = 'none';
                document.getElementById('confirmSendWhatsAppBtn').style.display = 'none';
                document.getElementById('downloadImageBtn').style.display = 'none';
                document.getElementById('imagePreview').innerHTML = '';
                currentDocumentImage = null;
            });
            
            // Initialize
            updateItemNumbers();
            updateItemsTable();
            calculateTotal();
        });
    </script>
</body>
</html>
